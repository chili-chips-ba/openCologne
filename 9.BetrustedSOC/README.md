# Betrusted SOC
 Port the barebones of BetrustedSOC to GateMate, namely only VexRiscv CPU and UART. We view this as the stepping stone for the next NLnet project with Cologne Chip, perhaps using one of their yet to be released 40K or 80K LUT devices. It's worth noting that BetrustedSOC is hosted in a Spartan7 (XC7S50), which is a 50K LUT6 device, 80% utilized as of October 2022. The native BetrustedSOC is implemented using proprietary Vivado 2019.2 toolchain, and also employs a 5K LUT4 Lattice UP5 FPGA for housekeeping tasks. The full BetrustedSOC would be a very nice and interesting thing to do. However, given its complexity, it's a project of its own. Our WP9 is merely to test the waters and set the stage for a yet to be defined follow-on project dedicated to BetrustedSOC. The idea is that by then, thanks to work on this project, Cologne tools will be sufficiently improved to eliminate their current choke points when it comes to complex logic, large homogeneus designs, as well as timing and routing related issues.
<!-- Within this work package, we also plan to create a comprehensive blog that describes all FPGA/RTL developed for the project. -->
---

## Prerequisites

Please refer to the [betrusted-soc repository](https://github.com/betrusted-io/betrusted-soc) for the full list of prerequisites. In addition to the dependencies listed there, the **GateMate toolchain** is required for this port. It’s strongly recommended to use an **isolated Python environment** (e.g., via `venv`) to avoid conflicts with global or newer tool versions, as this project depends on specific versions of LiteX and related tools.

---

## Porting Overview

The Betrusted SoC is a LiteX-based, secure, privacy-focused system-on-chip built around the VexRiscv core, originally designed to run on Xilinx Spartan FPGAs for the Precursor mobile device. The complete SoC integrates various peripherals such as external SRAM, SPI flash, audio, timers, TRNGs, and cryptographic cores. It also relies on features such as bitstream encryption, false path constraints for timing closure, and other capabilities specific to the Xilinx toolchain.

These features are **not available** on the GateMate platform. Therefore, for this project, we are targeting a **minimal port** of Betrusted SoC that includes only the **VexRiscv CPU** and **UART** peripheral. This simplified version is intended to serve as a prototype for future work on larger GateMate-based designs (e.g., with 40K or 80K LUT devices).

---

## Current Status

✅ Basic hardware build for GateMate with VexRiscv + UART

❌ Bare-metal software app still in development

❌ No hardware simulation yet performed

❌ BIOS-based software loading


---

## Porting Tasks

* [x] Strip down Betrusted SoC to VexRiscv and UART
* [x] Update and adapt LiteX build system for GateMate
* [ ] Build and run a simple bare-metal test application
* [ ] Simulate and validate the hardware build
* [ ] Enable boot-time UART software loading using LiteX BIOS
* [ ] Incrementally reintroduce additional Betrusted SoC peripherals and features

---

## Notes on Software Build Process

There are two ways to build software in LiteX:

1. **Integrated build** using `Builder(compile_software=True)`: builds the LiteX BIOS along with an application. Useful for ROM-booted systems.
2. **Manual standalone build**: allows targeting bare-metal apps directly. Useful when BIOS integration is not desired or not working.

Challenges encountered so far:

*  The LiteX project offers limited documentation for bare-metal software development. As a reference, we're using the example in `deps/litex/litex/soc/software/demo`, which requires manual adjustment to build correctly.
*  Signed boot support (as in the original Betrusted setup) has been excluded due to incompatibilities in tool versions (Rust).
*  The software stack relies on **Picolibc**, a minimal embedded C library. However, `picolibc.h` is not generated by default in the LiteX environment. We've temporarily worked around this by providing a manually-created stub header.
*  The hardware build process generates `include/` headers and software build paths within the `build/` directory, but since this directory is wiped on rebuilds, we are developing software externally in `software/` to avoid accidental data loss.

---

## References

* [betrusted-io/betrusted-soc](https://github.com/betrusted-io/betrusted-soc)